contract_type: feature
feature_name: architecture
version: 1
description: Cross-cutting architecture invariants for the PastChats memory system.
issue: "#1"

non_negotiable_rules:
  - id: ARCH-001
    rule: "SQLite access MUST be isolated to store layer"
    severity: critical
    enforcement: contract_test
    required_patterns:
      - pattern: "import sqlite3"
        in_files: "src/pastchats_memory/store.py"
        description: "Store layer owns DB access"
    forbidden_patterns:
      - pattern: "import sqlite3"
        in_files: "src/pastchats_memory/*.py"
        description: "No direct DB imports in non-store modules"

  - id: ARCH-002
    rule: "Prompt corpus MUST expose FTS5 index"
    severity: critical
    enforcement: contract_test
    required_patterns:
      - pattern: "CREATE VIRTUAL TABLE IF NOT EXISTS prompts_fts USING fts5"
        in_files: "src/pastchats_memory/schema.sql"
        description: "Lexical search requires FTS5 virtual table"

  - id: ARCH-003
    rule: "CLI MUST expose pre-task recall command"
    severity: critical
    enforcement: contract_test
    required_patterns:
      - pattern: "sub\.add_parser\(\"recall\""
        in_files: "src/pastchats_memory/cli.py"
        description: "Recall command is mandatory for memory priming"

  - id: ARCH-004
    rule: "CLI MUST expose Claude Code hook entrypoints for pre-task recall and capture"
    severity: important
    enforcement: contract_test
    required_patterns:
      - pattern: "hook-user-prompt-submit"
        in_files: "src/pastchats_memory/cli.py"
        description: "UserPromptSubmit hook command exists"
      - pattern: "hook-stop"
        in_files: "src/pastchats_memory/cli.py"
        description: "Stop hook command exists"

compliance_checklist:
  - "Only store.py imports sqlite3"
  - "Schema defines prompts_fts FTS5 virtual table"
  - "CLI has recall entrypoint"
  - "CLI has Claude Code hook entrypoints"

test_hooks:
  tests:
    - file: "tests/contracts/test_architecture_contract.py"
      covers:
        - ARCH-001
        - ARCH-002
        - ARCH-003
        - ARCH-004
